<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zona Gamer - Carrito</title>

<link rel="stylesheet" href="css/styleCarrito.css">
</head>

<body>

<button class="theme-btn" onclick="toggleTheme()">üåô</button>

<div class="contenedor">
    <h1>üõí Carrito</h1>

    <div id="carrito" class="lista-carrito"></div>

    <h3 id="total" class="total"></h3>

    <div class="acciones">
        <button class="btn-finalizar" onclick="finalizar()">Finalizar compra</button>
        <a href="productos.html" class="volver">‚Üê Volver</a>
    </div>
</div>

<script>
let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

function render() {
    const contenedor = document.getElementById("carrito");
    contenedor.innerHTML = "";
    let total = 0;

    carrito.forEach(p => {
        total += p.precio * p.cantidad;

        contenedor.innerHTML += `
            <div class="item">
                <span>${p.nombre} x${p.cantidad}</span>
                <div>
                    <button onclick="sumar(${p.id})">+</button>
                    <button onclick="restar(${p.id})">-</button>
                </div>
            </div>
        `;
    });

    document.getElementById("total").innerText = "Total: $" + total;
}

function sumar(id) {
    carrito.find(p => p.id === id).cantidad++;
    guardar();
}

function restar(id) {
    const prod = carrito.find(p => p.id === id);
    prod.cantidad--;
    if (prod.cantidad <= 0)
        carrito = carrito.filter(p => p.id !== id);
    guardar();
}

function guardar() {
    localStorage.setItem("carrito", JSON.stringify(carrito));
    render();
}

async function finalizar() {
    if (carrito.length === 0) {
        alert("El carrito est√° vac√≠o");
        return;
    }

    if (!confirm("¬øConfirmar compra?")) return;

    const nombre = localStorage.getItem("nombreUsuario");

    const res = await fetch("http://localhost:3000/api/ventas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            nombre_cliente: nombre, 
            productos: carrito.map(p => ({
                id: p.id,
                cantidad: p.cantidad
            }))
        })
    });

    if (!res.ok) {
        alert("Error al crear la venta");
        return;
    }

    const data = await res.json();

    localStorage.removeItem("carrito");
    localStorage.setItem("ticket", JSON.stringify(data.venta));
    window.location.href = "ticket.html";
}

function toggleTheme() {
    document.body.classList.toggle("dark");
    localStorage.setItem("tema",
        document.body.classList.contains("dark") ? "dark" : "light"
    );
}

window.onload = function () {
    if (localStorage.getItem("tema") === "dark") {
        document.body.classList.add("dark");
    }
    render();
};
</script>

</body>
</html>